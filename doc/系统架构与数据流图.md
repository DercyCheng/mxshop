# 系统架构与数据流图

本文档提供 Shop 电商微服务系统的架构图和数据流图，帮助开发者理解系统组件间的关系和数据流转过程。

## 系统架构总览

Shop 电商系统采用分层微服务架构，主要分为前端层、API网关层、服务层和基础设施层。

```
┌─────────────────────────────────────┐
│            前端应用层                │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐│
│  │ Web前端 │ │移动应用 │ │管理后台 ││
│  └─────────┘ └─────────┘ └─────────┘│
└───────────────────┬─────────────────┘
                    │
┌───────────────────▼─────────────────┐
│            API网关层                 │
│  ┌─────────────────────────────────┐│
│  │          Nginx/Kong             ││
│  └─────────────────────────────────┘│
└───┬───────────┬───────────┬─────────┘
    │           │           │
┌───▼───┐   ┌───▼───┐   ┌───▼───┐
│用户API│   │商品API│   │订单API│ ...
└───┬───┘   └───┬───┘   └───┬───┘
    │           │           │
┌───▼───┐   ┌───▼───┐   ┌───▼───┐
│用户服务│   │商品服务│   │订单服务│ ...
└───┬───┘   └───┬───┘   └───┬───┘
    │           │           │
┌───▼───────────▼───────────▼───────┐
│          基础设施层               │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ │
│  │MySQL│ │Redis│ │MQ   │ │ES   │ │
│  └─────┘ └─────┘ └─────┘ └─────┘ │
│  ┌─────┐ ┌─────┐ ┌─────────────┐ │
│  │Nacos│ │Consul│ │Jaeger      │ │
│  └─────┘ └─────┘ └─────────────┘ │
└─────────────────────────────────┘
```

## 服务间依赖关系图

以下图表展示了各微服务之间的依赖关系：

```
                            ┌──────────────┐
                    ┌───────►  用户服务    │
                    │       │  (user_srv)  │
                    │       └──────────────┘
                    │              △
                    │              │
┌──────────────┐    │       ┌──────────────┐
│ 用户操作服务  ◄────┘       │  商品服务    │
│ (userop_srv) │            │ (goods_srv)  │
└──────┬───────┘            └──────┬───────┘
       │                            │
       │                            │
       │        ┌──────────────┐    │
       └────────►  订单服务    ◄─────┘
                │ (order_srv)  │
                └──────┬───────┘
                       │
                       │
                       ▼
                ┌──────────────┐
                │  库存服务    │
                │(inventory_srv)│
                └──────────────┘
```

## 主要业务流程数据流图

### 1. 用户下单流程

```
┌─────────┐        ┌─────────┐        ┌─────────┐        ┌─────────┐        ┌─────────┐
│ 用户API  │        │ 订单服务 │        │ 商品服务 │        │ 库存服务 │        │  MQ     │
└────┬────┘        └────┬────┘        └────┬────┘        └────┬────┘        └────┬────┘
     │      创建订单     │                  │                  │                  │
     │ ─────────────────>                  │                  │                  │
     │                  │                  │                  │                  │
     │                  │     查询商品      │                  │                  │
     │                  │ ─────────────────>                  │                  │
     │                  │                  │                  │                  │
     │                  │    返回商品信息   │                  │                  │
     │                  │ <─────────────────                  │                  │
     │                  │                  │                  │                  │
     │                  │               锁定库存              │                  │
     │                  │ ───────────────────────────────────>                  │
     │                  │                  │                  │                  │
     │                  │              库存锁定结果           │                  │
     │                  │ <───────────────────────────────────                  │
     │                  │                  │                  │                  │
     │                  │                 发送订单创建事件     │                  │
     │                  │ ──────────────────────────────────────────────────────>
     │                  │                  │                  │                  │
     │    订单创建结果   │                  │                  │                  │
     │ <─────────────────                  │                  │                  │
     │                  │                  │                  │    消费订单事件   │
     │                  │                  │                  │ <─────────────────
     │                  │                  │                  │                  │
     │                  │                  │                  │    更新库存状态   │
     │                  │                  │                  │ ─────────────────>
     │                  │                  │                  │                  │
```

### 2. 用户登录流程

```
┌─────────┐        ┌─────────┐        ┌─────────┐        ┌─────────┐
│ 用户API  │        │ 用户服务 │        │  Redis  │        │  MQ     │
└────┬────┘        └────┬────┘        └────┬────┘        └────┬────┘
     │       登录请求    │                  │                  │
     │ ─────────────────>                  │                  │
     │                  │                  │                  │
     │                  │     查询用户      │                  │
     │                  │ ─────────────────>                  │
     │                  │                  │                  │
     │                  │   缓存未命中     │                  │
     │                  │ <─────────────────                  │
     │                  │                  │                  │
     │                  │    查询数据库    │                  │
     │                  │ ─────┐           │                  │
     │                  │      │           │                  │
     │                  │ <────┘           │                  │
     │                  │                  │                  │
     │                  │    更新缓存      │                  │
     │                  │ ─────────────────>                  │
     │                  │                  │                  │
     │                  │                 记录登录事件        │
     │                  │ ──────────────────────────────────>│
     │                  │                  │                  │
     │     JWT Token    │                  │                  │
     │ <─────────────────                  │                  │
     │                  │                  │                  │
```

### 3. 商品搜索流程

```
┌─────────┐        ┌─────────┐        ┌─────────┐        ┌─────────┐
│ 商品API  │        │ 商品服务 │        │ElasticSearch│    │  MySQL  │
└────┬────┘        └────┬────┘        └────┬────┘        └────┬────┘
     │      搜索请求     │                  │                  │
     │ ─────────────────>                  │                  │
     │                  │                  │                  │
     │                  │     ES搜索       │                  │
     │                  │ ─────────────────>                  │
     │                  │                  │                  │
     │                  │    搜索结果      │                  │
     │                  │ <─────────────────                  │
     │                  │                  │                  │
     │                  │              补充商品详情           │
     │                  │ ───────────────────────────────────>
     │                  │                  │                  │
     │                  │              商品详情数据           │
     │                  │ <───────────────────────────────────
     │                  │                  │                  │
     │    搜索结果列表   │                  │                  │
     │ <─────────────────                  │                  │
     │                  │                  │                  │
```

## 服务内部组件图

### 用户服务 (user_srv)

```
┌─────────────────────────────────────────────┐
│               用户服务 (user_srv)            │
│                                             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │  用户管理   │       │  认证服务   │      │
│  └──────┬──────┘       └──────┬──────┘      │
│         │                     │             │
│         ▼                     ▼             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │ 用户仓储接口 │       │ 权限管理   │      │
│  └──────┬──────┘       └─────────────┘      │
│         │                                   │
│         ▼                                   │
│  ┌─────────────┐                            │
│  │  MySQL实现  │                            │
│  └─────────────┘                            │
└─────────────────────────────────────────────┘
```

### 商品服务 (goods_srv)

```
┌─────────────────────────────────────────────┐
│             商品服务 (goods_srv)             │
│                                             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │ 商品管理    │       │ 分类管理    │      │
│  └──────┬──────┘       └──────┬──────┘      │
│         │                     │             │
│         ▼                     ▼             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │ 品牌管理    │       │ 商品搜索    │      │
│  └──────┬──────┘       └──────┬──────┘      │
│         │                     │             │
│         ▼                     ▼             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │ MySQL存储   │       │ ES搜索引擎  │      │
│  └─────────────┘       └─────────────┘      │
└─────────────────────────────────────────────┘
```

### 订单服务 (order_srv)

```
┌─────────────────────────────────────────────┐
│             订单服务 (order_srv)             │
│                                             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │ 订单管理    │       │ 购物车管理  │      │
│  └──────┬──────┘       └─────────────┘      │
│         │                                   │
│         ▼                                   │
│  ┌─────────────┐       ┌─────────────┐      │
│  │ 支付集成    │       │ 订单状态机  │      │
│  └─────────────┘       └──────┬──────┘      │
│                               │             │
│                               ▼             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │ MySQL存储   │       │ 消息发布    │      │
│  └─────────────┘       └─────────────┘      │
└─────────────────────────────────────────────┘
```

### 库存服务 (inventory_srv)

```
┌─────────────────────────────────────────────┐
│           库存服务 (inventory_srv)           │
│                                             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │ 库存管理    │       │ 库存锁定    │      │
│  └──────┬──────┘       └──────┬──────┘      │
│         │                     │             │
│         ▼                     ▼             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │ 库存释放    │       │ 库存同步    │      │
│  └─────────────┘       └─────────────┘      │
│                                             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │ MySQL存储   │       │ 消息消费    │      │
│  └─────────────┘       └─────────────┘      │
└─────────────────────────────────────────────┘
```

## 数据库表关系图

### 用户服务数据库

```
┌───────────────┐       ┌───────────────┐
│    user       │       │    role       │
├───────────────┤       ├───────────────┤
│ id            │       │ id            │
│ mobile        │       │ name          │
│ password      │       │ description   │
│ nickname      │       └───────┬───────┘
│ birthday      │               │
│ gender        │               │
│ role_id       │◄──────────────┘
└───────────────┘
```

### 商品服务数据库

```
┌───────────────┐       ┌───────────────┐       ┌───────────────┐
│   category    │       │     brand     │       │   goods       │
├───────────────┤       ├───────────────┤       ├───────────────┤
│ id            │       │ id            │       │ id            │
│ name          │       │ name          │       │ name          │
│ parent_id     │       │ logo          │       │ category_id   │◄────┐
│ level         │       └───────────────┘       │ brand_id      │◄──┐ │
└───────┬───────┘               ▲               │ price         │   │ │
        │                       │               │ desc          │   │ │
        │                       │               │ is_hot        │   │ │
        └───────────────────────┼───────────────┘               │   │
                                │                               │   │
                                └───────────────────────────────┘   │
                                                                    │
                                                                    │
┌───────────────┐       ┌───────────────┐                          │
│  goods_attr   │       │ banner        │                          │
├───────────────┤       ├───────────────┤                          │
│ id            │       │ id            │                          │
│ goods_id      │◄──────┤ image         │                          │
│ attr_name     │       │ url           │                          │
│ attr_value    │       │ goods_id      │◄─────────────────────────┘
└───────────────┘       └───────────────┘
```

### 订单服务数据库

```
┌───────────────┐       ┌───────────────┐
│    order      │       │  order_goods  │
├───────────────┤       ├───────────────┤
│ id            │       │ id            │
│ user_id       │       │ order_id      │◄─────┐
│ status        │◄──────┤ goods_id      │      │
│ total         │       │ count         │      │
│ address       │       │ price         │      │
│ pay_type      │       └───────────────┘      │
│ pay_time      │                              │
└───────────────┘                              │
                                               │
┌───────────────┐                              │
│    payment    │                              │
├───────────────┤                              │
│ id            │                              │
│ order_id      │◄─────────────────────────────┘
│ pay_no        │
│ status        │
│ amount        │
└───────────────┘
```

### 库存服务数据库

```
┌───────────────┐       ┌───────────────┐
│   inventory   │       │ inventory_log │
├───────────────┤       ├───────────────┤
│ id            │       │ id            │
│ goods_id      │       │ inventory_id  │◄────┐
│ stocks        │◄──────┤ order_id      │     │
│ version       │       │ status        │     │
└───────────────┘       │ detail        │     │
                        └───────────────┘     │
                                              │
┌───────────────┐                             │
│ inventory_lock│                             │
├───────────────┤                             │
│ id            │                             │
│ inventory_id  │◄────────────────────────────┘
│ order_id      │
│ count         │
│ status        │
└───────────────┘
```

## 部署架构图

### 开发环境部署

```
┌─────────────────────────────────────────────┐
│              开发环境部署(Docker Compose)    │
│                                             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │  MySQL      │       │  Redis      │      │
│  └─────────────┘       └─────────────┘      │
│                                             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │  Nacos      │       │  Consul     │      │
│  └─────────────┘       └─────────────┘      │
│                                             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │  RocketMQ   │       │ Elastic     │      │
│  └─────────────┘       └─────────────┘      │
│                                             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │  Jaeger     │       │  Nginx      │      │
│  └─────────────┘       └─────────────┘      │
└─────────────────────────────────────────────┘
```

### 生产环境部署

```
┌─────────────────────────────────────────────┐
│              生产环境部署(Kubernetes)        │
│                                             │
│  ┌─────────────────────────────────────┐    │
│  │  API网关集群 (Kong/Nginx)            │    │
│  └─────────────────────────────────────┘    │
│                                             │
│  ┌─────────────────────────────────────┐    │
│  │  微服务集群 (用户/商品/订单/库存)     │    │
│  └─────────────────────────────────────┘    │
│                                             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │ MySQL集群   │       │ Redis集群   │      │
│  └─────────────┘       └─────────────┘      │
│                                             │
│  ┌─────────────┐       ┌─────────────┐      │
│  │  ES集群     │       │  MQ集群     │      │
│  └─────────────┘       └─────────────┘      │
│                                             │
│  ┌─────────────────────────────────────┐    │
│  │  监控系统(Prometheus/Grafana)        │    │
│  └─────────────────────────────────────┘    │
└─────────────────────────────────────────────┘
```

## 参考资料

- [微服务设计模式](https://microservices.io/patterns/index.html)
- [数据流图符号表示法](https://en.wikipedia.org/wiki/Data-flow_diagram)
- [C4模型](https://c4model.com/)

## 文档维护

1. 所有架构变更需要在架构决策记录(ADR)中记录
2. 架构变更后，需同步更新本文档中的相关图表
3. 使用标准符号表示法保持图表一致性
4. 保持图表的简洁和可读性